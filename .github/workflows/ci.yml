name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  check-registries:
    name: Check registries are up-to-date
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.2

      - name: Install dependencies
        run: bun install

      - name: Regenerate registries and exports
        run: bun run generate

      - name: Check if files are up-to-date
        run: |
          if ! git diff --exit-code packages/react-native/src/registry.json packages/react-native/src/docs-registry.ts packages/react-native/src/index.ts; then
            echo "Error: Registry files are not up-to-date!"
            echo "Please run 'bun run generate' locally and commit the changes."
            exit 1
          fi

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.2

      - name: Install dependencies
        run: bun install

      - name: Run linter
        run: bun run lint

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.2

      - name: Install dependencies
        run: bun install

      - name: Run type checking
        run: bun run check-types

  test:
    name: Test with Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.2

      - name: Install dependencies
        run: bun install

      - name: Run tests with coverage
        run: bun run test

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: packages/react-native/coverage/
          retention-days: 30

      - name: Display coverage summary
        run: |
          echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat packages/react-native/coverage/coverage-summary.json | \
            jq -r '.total | "- **Lines:** \(.lines.pct)%\n- **Statements:** \(.statements.pct)%\n- **Functions:** \(.functions.pct)%\n- **Branches:** \(.branches.pct)%"' >> $GITHUB_STEP_SUMMARY

      - name: Update coverage badge
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          GIST_ID: ${{ secrets.GIST_ID }}
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: bun run scripts/update-coverage-badge.ts
